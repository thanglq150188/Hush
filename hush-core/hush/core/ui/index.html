<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hush Trace Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'lf-bg': '#0d1117',
            'lf-bg-secondary': '#161b22',
            'lf-bg-tertiary': '#21262d',
            'lf-border': '#30363d',
            'lf-text': '#e6edf3',
            'lf-text-muted': '#8b949e',
            'lf-accent': '#58a6ff',
            'lf-green': '#3fb950',
            'lf-yellow': '#d29922',
            'lf-red': '#f85149',
            'lf-purple': '#a371f7',
            'lf-orange': '#db6d28',
            'lf-pink': '#db61a2',
            'lf-cyan': '#39c5cf',
          }
        }
      }
    }
  </script>
  <style>
    body { background: #0d1117; color: #e6edf3; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #161b22; }
    ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #484f58; }
    .tree-node:hover { background: #21262d; }
    .tree-node.selected { background: #1f6feb33; border-left: 2px solid #58a6ff; }
    .tree-line { border-left: 1px solid #30363d; }
    .tree-children { overflow: hidden; }
    .tree-children.collapsed { display: none; }
    .tree-toggle { transition: transform 0.15s ease; }
    .tree-toggle.collapsed { transform: rotate(-90deg); }
    .iteration-group { background: #161b2280; border-left: 2px solid #30363d; margin-left: 4px; }
    .iteration-badge { background: #30363d; color: #8b949e; font-size: 10px; padding: 1px 6px; border-radius: 4px; }
    .json-key { color: #ff7b72; }
    .json-string { color: #a5d6ff; }
    .json-number { color: #79c0ff; }
    .json-boolean { color: #ff7b72; }
    .json-null { color: #8b949e; }
    .badge { padding: 2px 8px; border-radius: 9999px; font-size: 11px; font-weight: 500; }
    .badge-green { background: #238636; color: #3fb950; }
    .badge-yellow { background: #9e6a03; color: #d29922; }
    .badge-blue { background: #1f6feb; color: #58a6ff; }
    .badge-purple { background: #8957e5; color: #a371f7; }
    .icon-span { color: #58a6ff; }
    .icon-generation { color: #a371f7; }
    .icon-trace { color: #3fb950; }
  </style>
</head>
<body class="min-h-screen">
  <div id="app" class="h-screen flex flex-col">

    <!-- ==================== TRACE LIST PAGE ==================== -->
    <div id="trace-list-page" class="flex-1 flex flex-col">
      <!-- Header -->
      <header class="flex items-center justify-between px-6 py-4 border-b border-lf-border bg-lf-bg-secondary">
        <div class="flex items-center gap-4">
          <h1 class="text-xl font-semibold text-lf-text">Traces</h1>
          <span id="db-status" class="text-xs text-lf-text-muted"></span>
        </div>
        <div class="flex items-center gap-3">
          <button id="reload-btn" class="px-3 py-1.5 text-sm bg-lf-bg-tertiary hover:bg-lf-border rounded-md transition-colors text-lf-text">
            Reload
          </button>
        </div>
      </header>

      <!-- Filters -->
      <div class="px-6 py-3 border-b border-lf-border bg-lf-bg flex items-center gap-4">
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 text-lf-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <input type="text" id="search-input" placeholder="Search traces..."
            class="w-64 px-3 py-1.5 text-sm bg-lf-bg-secondary border border-lf-border rounded-md text-lf-text placeholder-lf-text-muted focus:outline-none focus:border-lf-accent">
        </div>
        <select id="workflow-filter" class="px-3 py-1.5 text-sm bg-lf-bg-secondary border border-lf-border rounded-md text-lf-text focus:outline-none focus:border-lf-accent">
          <option value="">All Workflows</option>
        </select>
        <span id="trace-count" class="text-sm text-lf-text-muted ml-auto"></span>
      </div>

      <!-- Trace Table -->
      <div class="flex-1 overflow-auto">
        <table class="w-full">
          <thead class="sticky top-0 bg-lf-bg-secondary border-b border-lf-border">
            <tr class="text-left text-xs text-lf-text-muted uppercase tracking-wider">
              <th class="px-6 py-3 font-medium">Trace</th>
              <th class="px-6 py-3 font-medium">Timestamp</th>
              <th class="px-6 py-3 font-medium text-right">Latency</th>
              <th class="px-6 py-3 font-medium text-right">Tokens</th>
              <th class="px-6 py-3 font-medium text-right">Cost</th>
            </tr>
          </thead>
          <tbody id="trace-table-body" class="divide-y divide-lf-border">
          </tbody>
        </table>

        <!-- Empty State -->
        <div id="empty-state" class="hidden flex-1 flex items-center justify-center py-20">
          <div class="text-center">
            <svg class="w-16 h-16 mx-auto text-lf-border mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <p id="empty-message" class="text-lf-text-muted">Loading traces...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== TRACE DETAIL PAGE ==================== -->
    <div id="trace-detail-page" class="hidden flex-1 flex flex-col">
      <!-- Header -->
      <header class="flex items-center gap-4 px-6 py-4 border-b border-lf-border bg-lf-bg-secondary">
        <button id="back-btn" class="p-1 hover:bg-lf-bg-tertiary rounded transition-colors">
          <svg class="w-5 h-5 text-lf-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
        </button>
        <div class="flex items-center gap-3">
          <span class="text-lg font-semibold text-lf-text" id="detail-workflow-name"></span>
        </div>
        <div class="ml-auto flex items-center gap-4 text-sm">
          <div class="flex items-center gap-2">
            <span class="text-lf-text-muted">Latency:</span>
            <span id="detail-latency" class="badge badge-yellow"></span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-lf-text-muted">Tokens:</span>
            <span id="detail-tokens" class="text-lf-text"></span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-lf-text-muted">Cost:</span>
            <span id="detail-cost" class="text-lf-text"></span>
          </div>
        </div>
      </header>

      <!-- Content: Tree + Detail -->
      <div class="flex-1 flex overflow-hidden">
        <!-- Tree Panel -->
        <div class="w-[420px] min-w-[320px] border-r border-lf-border flex flex-col bg-lf-bg">
          <!-- Tree Header -->
          <div class="px-4 py-3 border-b border-lf-border flex items-center justify-between">
            <span class="text-sm font-medium text-lf-text-muted">Trace Timeline</span>
            <span id="detail-timestamp" class="text-xs text-lf-text-muted"></span>
          </div>
          <!-- Tree Content -->
          <div id="tree-container" class="flex-1 overflow-auto py-2">
          </div>
        </div>

        <!-- Detail Panel -->
        <div class="flex-1 flex flex-col bg-lf-bg-secondary overflow-hidden">
          <!-- Detail Header -->
          <div id="detail-header" class="px-6 py-4 border-b border-lf-border">
            <div class="text-lf-text-muted text-sm">Select a node to view details</div>
          </div>
          <!-- Detail Content -->
          <div id="detail-content" class="flex-1 overflow-auto p-6">
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== STATE ====================
    let db = null;
    let SQL = null;
    let traces = [];
    let currentTrace = null;
    let selectedNode = null;
    let nodeById = new Map();

    // ==================== DOM ====================
    const traceListPage = document.getElementById('trace-list-page');
    const traceDetailPage = document.getElementById('trace-detail-page');
    const traceTableBody = document.getElementById('trace-table-body');
    const searchInput = document.getElementById('search-input');
    const workflowFilter = document.getElementById('workflow-filter');
    const traceCount = document.getElementById('trace-count');
    const dbStatus = document.getElementById('db-status');
    const emptyState = document.getElementById('empty-state');
    const emptyMessage = document.getElementById('empty-message');
    const backBtn = document.getElementById('back-btn');
    const reloadBtn = document.getElementById('reload-btn');

    // ==================== INIT ====================
    async function initSQL() {
      if (!SQL) {
        SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}` });
      }
      return SQL;
    }

    async function loadDatabase() {
      emptyState.classList.remove('hidden');
      emptyMessage.textContent = 'Loading database...';
      traceTableBody.innerHTML = '';

      try {
        const statusRes = await fetch('/api/status');
        if (!statusRes.ok) throw new Error('Server not available');
        const status = await statusRes.json();

        if (!status.db_exists) {
          emptyMessage.textContent = 'No traces found';
          dbStatus.textContent = status.db_path;
          return;
        }

        const dbRes = await fetch('/api/db');
        if (!dbRes.ok) throw new Error('Failed to fetch database');
        const buffer = await dbRes.arrayBuffer();

        await initSQL();
        db = new SQL.Database(new Uint8Array(buffer));

        const sizeKB = Math.round(status.db_size / 1024);
        dbStatus.textContent = `${sizeKB} KB`;

        loadTraces();
      } catch (err) {
        console.error(err);
        emptyMessage.textContent = 'Failed to load database';
        dbStatus.textContent = 'Error';
      }
    }

    reloadBtn.addEventListener('click', loadDatabase);
    loadDatabase();

    // ==================== TRACE LIST ====================
    function loadTraces() {
      const result = db.exec(`
        SELECT
          request_id,
          workflow_name,
          user_id,
          MIN(start_time) as start_time,
          MAX(end_time) as end_time,
          MIN(created_at) as created_at,
          SUM(COALESCE(duration_ms, 0)) as total_duration,
          SUM(COALESCE(total_tokens, 0)) as total_tokens,
          SUM(COALESCE(prompt_tokens, 0)) as prompt_tokens,
          SUM(COALESCE(completion_tokens, 0)) as completion_tokens,
          SUM(COALESCE(cost_usd, 0)) as total_cost,
          COUNT(*) as node_count
        FROM traces
        GROUP BY request_id
        ORDER BY MIN(created_at) DESC
        LIMIT 500
      `);

      if (!result.length) {
        traces = [];
        emptyState.classList.remove('hidden');
        emptyMessage.textContent = 'No traces found';
        return;
      }

      emptyState.classList.add('hidden');
      const cols = result[0].columns;
      traces = result[0].values.map(row => {
        const obj = {};
        cols.forEach((col, i) => obj[col] = row[i]);
        return obj;
      });

      // Populate workflow filter
      const workflows = [...new Set(traces.map(t => t.workflow_name))];
      workflowFilter.innerHTML = '<option value="">All Workflows</option>' +
        workflows.map(w => `<option value="${w}">${w}</option>`).join('');

      renderTraceList();
    }

    function renderTraceList() {
      const search = searchInput.value.toLowerCase();
      const workflow = workflowFilter.value;

      const filtered = traces.filter(t => {
        if (workflow && t.workflow_name !== workflow) return false;
        if (search && !t.workflow_name.toLowerCase().includes(search) && !t.request_id.toLowerCase().includes(search)) return false;
        return true;
      });

      traceCount.textContent = `${filtered.length} traces`;

      traceTableBody.innerHTML = filtered.map(t => `
        <tr class="hover:bg-lf-bg-tertiary cursor-pointer transition-colors" data-request-id="${t.request_id}">
          <td class="px-6 py-4">
            <div class="flex flex-col gap-1">
              <span class="font-medium text-lf-text">${escapeHtml(t.workflow_name)}</span>
              <span class="text-xs text-lf-text-muted font-mono">${t.request_id.slice(0, 12)}...</span>
            </div>
          </td>
          <td class="px-6 py-4 text-sm text-lf-text-muted">${formatDate(t.start_time || t.created_at)}</td>
          <td class="px-6 py-4 text-right">
            <span class="badge ${getDurationBadge(t.total_duration)}">${formatDuration(t.total_duration)}</span>
          </td>
          <td class="px-6 py-4 text-right text-sm text-lf-text">
            ${t.total_tokens > 0 ? `${formatNumber(t.prompt_tokens)} → ${formatNumber(t.completion_tokens)}` : '-'}
          </td>
          <td class="px-6 py-4 text-right text-sm ${t.total_cost > 0 ? 'text-lf-green' : 'text-lf-text-muted'}">
            ${formatCost(t.total_cost)}
          </td>
        </tr>
      `).join('');

      // Click handlers
      traceTableBody.querySelectorAll('tr').forEach(row => {
        row.addEventListener('click', () => loadTraceDetail(row.dataset.requestId));
      });
    }

    searchInput.addEventListener('input', renderTraceList);
    workflowFilter.addEventListener('change', renderTraceList);

    // ==================== TRACE DETAIL ====================
    function loadTraceDetail(requestId) {
      const result = db.exec(`
        SELECT * FROM traces
        WHERE request_id = '${requestId}'
        ORDER BY execution_order
      `);

      if (!result.length) return;

      const cols = result[0].columns;
      const nodes = result[0].values.map(row => {
        const obj = {};
        cols.forEach((col, i) => obj[col] = row[i]);

        // Calculate duration if missing
        if (!obj.duration_ms && obj.start_time && obj.end_time) {
          try {
            const start = new Date(obj.start_time).getTime();
            const end = new Date(obj.end_time).getTime();
            if (!isNaN(start) && !isNaN(end)) obj.duration_ms = end - start;
          } catch (e) {}
        }

        // Infer parent_name if missing
        if (!obj.parent_name && obj.node_name && obj.node_name.includes('.')) {
          obj.parent_name = obj.node_name.substring(0, obj.node_name.lastIndexOf('.'));
        }

        return obj;
      });

      currentTrace = { requestId, nodes };

      // Calculate totals
      const totalDuration = nodes.reduce((sum, n) => {
        if (!n.parent_name) return n.duration_ms || 0; // Root node duration
        return sum;
      }, 0) || nodes.reduce((sum, n) => sum + (n.duration_ms || 0), 0);
      const totalTokens = nodes.reduce((sum, n) => sum + (n.total_tokens || 0), 0);
      const promptTokens = nodes.reduce((sum, n) => sum + (n.prompt_tokens || 0), 0);
      const completionTokens = nodes.reduce((sum, n) => sum + (n.completion_tokens || 0), 0);
      const totalCost = nodes.reduce((sum, n) => sum + (n.cost_usd || 0), 0);

      // Update header
      document.getElementById('detail-workflow-name').textContent = nodes[0]?.workflow_name || 'Unknown';
      document.getElementById('detail-latency').textContent = formatDuration(totalDuration);
      document.getElementById('detail-tokens').textContent = totalTokens > 0 ? `${formatNumber(promptTokens)} → ${formatNumber(completionTokens)} (${formatNumber(totalTokens)})` : '-';
      document.getElementById('detail-cost').textContent = formatCost(totalCost);
      document.getElementById('detail-timestamp').textContent = formatDate(nodes[0]?.start_time || nodes[0]?.created_at);

      renderTree(nodes);
      showPage('detail');
      selectedNode = null;
      document.getElementById('detail-header').innerHTML = '<div class="text-lf-text-muted text-sm">Select a node to view details</div>';
      document.getElementById('detail-content').innerHTML = '';
    }

    // ==================== TREE ====================
    function renderTree(nodes) {
      nodeById = new Map();
      const nodesByName = new Map();
      const allNodes = [];

      // Index all nodes
      nodes.forEach(n => {
        n.children = [];
        n._isReal = true;

        // Check if this is a synthetic iteration group
        try {
          const meta = n.metadata ? JSON.parse(n.metadata) : null;
          if (meta && meta._iteration_group) {
            n._isIterationGroup = true;
            n._isReal = true; // Allow selection for iteration groups
          }
        } catch {}

        nodeById.set(n.id, n);
        allNodes.push(n);
        if (!nodesByName.has(n.node_name)) nodesByName.set(n.node_name, []);
        nodesByName.get(n.node_name).push(n);
      });

      // Create synthetic nodes for missing parents
      let syntheticId = -1;
      const missingParents = new Set();
      nodes.forEach(n => {
        if (n.parent_name && !nodesByName.has(n.parent_name)) {
          let current = n.parent_name;
          while (current && !nodesByName.has(current)) {
            missingParents.add(current);
            current = current.includes('.') ? current.substring(0, current.lastIndexOf('.')) : null;
          }
        }
      });

      [...missingParents].sort((a, b) => (a.match(/\./g) || []).length - (b.match(/\./g) || []).length)
        .forEach(name => {
          const synthetic = {
            id: syntheticId--,
            node_name: name,
            parent_name: name.includes('.') ? name.substring(0, name.lastIndexOf('.')) : null,
            children: [],
            _isReal: false,
            _isSynthetic: true,
          };
          allNodes.push(synthetic);
          nodeById.set(synthetic.id, synthetic);
          if (!nodesByName.has(name)) nodesByName.set(name, []);
          nodesByName.get(name).push(synthetic);
        });

      // Helper for context matching
      function getParentContext(contextId) {
        if (!contextId) return null;
        const lastDotBracket = contextId.lastIndexOf('].[');
        if (lastDotBracket === -1) return null;
        return contextId.substring(0, lastDotBracket + 1);
      }

      // Build tree
      const roots = [];
      allNodes.forEach(n => {
        if (!n.parent_name) { roots.push(n); return; }

        const potentialParents = nodesByName.get(n.parent_name);
        if (!potentialParents || potentialParents.length === 0) { roots.push(n); return; }

        let parent = null;
        if (potentialParents.length === 1) {
          parent = potentialParents[0];
        } else {
          if (n.context_id) {
            const expectedParentContext = getParentContext(n.context_id);
            parent = potentialParents.find(p => p.context_id === expectedParentContext);
            if (!parent) parent = potentialParents.find(p => p.context_id === n.context_id);
            if (!parent && !expectedParentContext) parent = potentialParents.find(p => !p.context_id);
          } else {
            parent = potentialParents.find(p => !p.context_id);
          }
          if (!parent) parent = potentialParents[0];
        }

        if (parent) parent.children.push(n);
        else roots.push(n);
      });

      // Sort
      const sortChildren = (node) => {
        node.children.sort((a, b) => (a.execution_order || 0) - (b.execution_order || 0));
        node.children.forEach(sortChildren);
      };
      roots.sort((a, b) => (a.execution_order || 0) - (b.execution_order || 0));
      roots.forEach(sortChildren);

      // Render
      const container = document.getElementById('tree-container');
      container.innerHTML = roots.map(n => renderTreeNode(n, 0)).join('');

      // Click handlers for node selection
      container.querySelectorAll('[data-node-id]').forEach(el => {
        el.addEventListener('click', (e) => {
          // Don't select if clicking toggle button
          if (e.target.closest('[data-toggle-id]')) return;
          e.stopPropagation();
          const nodeId = parseInt(el.dataset.nodeId);
          const node = nodeById.get(nodeId);
          if (node && node._isReal) selectNode(node);
        });
      });

      // Click handlers for toggle buttons (expand/collapse)
      container.querySelectorAll('[data-toggle-id]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const nodeId = btn.dataset.toggleId;
          const childrenEl = container.querySelector(`[data-children-id="${nodeId}"]`);
          if (childrenEl) {
            childrenEl.classList.toggle('collapsed');
            btn.classList.toggle('collapsed');
          }
        });
      });
    }

    function renderTreeNode(node, depth) {
      const hasChildren = node.children && node.children.length > 0;
      const isSynthetic = node._isSynthetic;
      const isGeneration = node.contain_generation;
      const isRoot = !node.parent_name;
      const isIterationGroup = node._isIterationGroup;

      let displayName = node.node_name.includes('.')
        ? node.node_name.substring(node.node_name.lastIndexOf('.') + 1)
        : node.node_name;

      // Check if this is an iteration group (iteration[N] or iteration[N][M]...)
      const iterationMatch = displayName.match(/^iteration(\[\d+\])+$/);

      // Icon based on node type
      let icon, iconClass;
      if (iterationMatch || isIterationGroup) {
        // Iteration group - use folder/repeat icon
        icon = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V8a2 2 0 00-2-2h-5L9 4H4z"/></svg>`;
        iconClass = 'text-lf-cyan';
      } else if (isSynthetic) {
        icon = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>`;
        iconClass = 'text-lf-text-muted';
      } else if (isGeneration) {
        icon = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>`;
        iconClass = 'icon-generation';
      } else if (isRoot) {
        icon = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 6a1 1 0 011-1h12a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6z" clip-rule="evenodd"/></svg>`;
        iconClass = 'icon-trace';
      } else if (hasChildren) {
        icon = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>`;
        iconClass = 'icon-span';
      } else {
        icon = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><circle cx="10" cy="10" r="3"/></svg>`;
        iconClass = 'icon-span';
      }

      const tokenInfo = node.total_tokens ? `${node.prompt_tokens || 0} → ${node.completion_tokens || 0}` : '';

      // Toggle button for nodes with children
      const toggleBtn = hasChildren ? `
        <button class="tree-toggle p-0.5 hover:bg-lf-bg-tertiary rounded" data-toggle-id="${node.id}">
          <svg class="w-3 h-3 text-lf-text-muted" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
          </svg>
        </button>
      ` : `<span class="w-4"></span>`;

      // Child count badge for iteration groups
      const childCountBadge = (iterationMatch || isIterationGroup) && hasChildren
        ? `<span class="iteration-badge">${node.children.length}</span>`
        : '';

      return `
        <div class="tree-node-container" data-container-id="${node.id}">
          <div data-node-id="${node.id}"
               class="tree-node flex items-center gap-1 px-2 py-1.5 cursor-pointer rounded-sm mx-1 ${isSynthetic || iterationMatch ? '' : ''}"
               style="padding-left: ${depth * 16 + 8}px">
            ${toggleBtn}
            <span class="${iconClass}">${icon}</span>
            <span class="flex-1 text-sm truncate ${isSynthetic ? 'italic text-lf-text-muted' : iterationMatch ? 'text-lf-cyan' : 'text-lf-text'}">${escapeHtml(displayName)}</span>
            ${childCountBadge}
            ${tokenInfo ? `<span class="text-xs text-lf-text-muted">${tokenInfo}</span>` : ''}
            ${node.duration_ms ? `<span class="text-xs font-medium ${getDurationColor(node.duration_ms)}">${formatDuration(node.duration_ms)}</span>` : ''}
          </div>
          ${hasChildren ? `<div class="tree-children" data-children-id="${node.id}">${node.children.map(c => renderTreeNode(c, depth + 1)).join('')}</div>` : ''}
        </div>
      `;
    }

    // ==================== NODE DETAIL ====================
    function selectNode(node) {
      selectedNode = node;

      // Update tree selection
      document.querySelectorAll('.tree-node').forEach(el => {
        el.classList.remove('selected');
        if (el.dataset.nodeId == node.id) el.classList.add('selected');
      });

      // Header
      const displayName = node.node_name.includes('.')
        ? node.node_name.substring(node.node_name.lastIndexOf('.') + 1)
        : node.node_name;

      document.getElementById('detail-header').innerHTML = `
        <div class="flex items-center gap-3">
          <span class="text-lg font-medium text-lf-text">${escapeHtml(displayName)}</span>
          ${node.model ? `<span class="badge badge-purple">${node.model}</span>` : ''}
          ${node.contain_generation ? `<span class="badge badge-purple">LLM</span>` : ''}
        </div>
        <div class="text-xs text-lf-text-muted mt-1 font-mono">${escapeHtml(node.node_name)}</div>
      `;

      // Parse JSON data
      let inputData = null, outputData = null, metadata = null;
      try { inputData = node.input ? JSON.parse(node.input) : null; } catch {}
      try { outputData = node.output ? JSON.parse(node.output) : null; } catch {}
      try { metadata = node.metadata ? JSON.parse(node.metadata) : null; } catch {}

      // Content
      document.getElementById('detail-content').innerHTML = `
        <!-- Metrics -->
        <div class="grid grid-cols-4 gap-4 mb-6">
          <div class="bg-lf-bg rounded-lg p-4 border border-lf-border">
            <div class="text-xs text-lf-text-muted mb-1">Duration</div>
            <div class="text-lg font-semibold ${getDurationColor(node.duration_ms)}">${formatDuration(node.duration_ms)}</div>
          </div>
          ${node.contain_generation ? `
          <div class="bg-lf-bg rounded-lg p-4 border border-lf-border">
            <div class="text-xs text-lf-text-muted mb-1">Input Tokens</div>
            <div class="text-lg font-semibold text-lf-text">${formatNumber(node.prompt_tokens || 0)}</div>
          </div>
          <div class="bg-lf-bg rounded-lg p-4 border border-lf-border">
            <div class="text-xs text-lf-text-muted mb-1">Output Tokens</div>
            <div class="text-lg font-semibold text-lf-text">${formatNumber(node.completion_tokens || 0)}</div>
          </div>
          <div class="bg-lf-bg rounded-lg p-4 border border-lf-border">
            <div class="text-xs text-lf-text-muted mb-1">Cost</div>
            <div class="text-lg font-semibold text-lf-green">${formatCost(node.cost_usd)}</div>
          </div>
          ` : `
          <div class="bg-lf-bg rounded-lg p-4 border border-lf-border">
            <div class="text-xs text-lf-text-muted mb-1">Order</div>
            <div class="text-lg font-semibold text-lf-text">#${node.execution_order || 0}</div>
          </div>
          <div class="bg-lf-bg rounded-lg p-4 border border-lf-border col-span-2">
            <div class="text-xs text-lf-text-muted mb-1">Time</div>
            <div class="text-sm text-lf-text">${node.start_time ? formatDateTime(node.start_time) : 'N/A'}</div>
          </div>
          `}
        </div>

        <!-- Input -->
        ${inputData ? `
        <div class="mb-6">
          <div class="flex items-center gap-2 mb-3">
            <span class="text-sm font-medium text-lf-text">Input</span>
            <span class="text-xs text-lf-text-muted">JSON</span>
          </div>
          <div class="bg-lf-bg rounded-lg border border-lf-border overflow-hidden">
            ${renderJsonTable(inputData)}
          </div>
        </div>
        ` : ''}

        <!-- Output -->
        ${outputData ? `
        <div class="mb-6">
          <div class="flex items-center gap-2 mb-3">
            <span class="text-sm font-medium text-lf-text">Output</span>
            <span class="text-xs text-lf-text-muted">JSON</span>
          </div>
          <div class="bg-lf-bg rounded-lg border border-lf-border overflow-hidden">
            ${renderJsonTable(outputData)}
          </div>
        </div>
        ` : ''}

        <!-- Metadata -->
        ${metadata ? `
        <div class="mb-6">
          <div class="flex items-center gap-2 mb-3">
            <span class="text-sm font-medium text-lf-text">Metadata</span>
            <span class="text-xs text-lf-text-muted">JSON</span>
          </div>
          <div class="bg-lf-bg rounded-lg border border-lf-border overflow-hidden">
            ${renderJsonTable(metadata)}
          </div>
        </div>
        ` : ''}
      `;

      // Toggle expand/collapse
      document.querySelectorAll('.json-toggle').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const row = e.target.closest('tr');
          const key = row.dataset.key;
          const childRows = document.querySelectorAll(`tr[data-parent="${key}"]`);
          const isExpanded = btn.textContent === '▼';
          btn.textContent = isExpanded ? '▶' : '▼';
          childRows.forEach(r => r.classList.toggle('hidden', isExpanded));
        });
      });
    }

    function renderJsonTable(obj, prefix = '', depth = 0) {
      if (obj === null || obj === undefined) return '<div class="p-4 text-lf-text-muted text-sm">null</div>';
      if (typeof obj !== 'object') return `<div class="p-4 text-sm">${renderValue(obj)}</div>`;

      const rows = [];
      const entries = Array.isArray(obj) ? obj.map((v, i) => [i, v]) : Object.entries(obj);

      for (const [key, value] of entries) {
        const fullKey = prefix ? `${prefix}.${key}` : String(key);
        const isExpandable = value !== null && typeof value === 'object';
        const displayKey = Array.isArray(obj) ? `${key}` : key;

        rows.push(`
          <tr class="border-b border-lf-border hover:bg-lf-bg-tertiary" data-key="${fullKey}" data-parent="${prefix}">
            <td class="px-4 py-2 text-sm text-lf-text-muted whitespace-nowrap align-top" style="padding-left: ${depth * 16 + 16}px">
              ${isExpandable ? `<button class="json-toggle mr-1 text-xs">▼</button>` : '<span class="mr-1 text-xs opacity-0">▶</span>'}
              <span class="${Array.isArray(obj) ? 'text-lf-purple' : ''}">${escapeHtml(String(displayKey))}</span>
            </td>
            <td class="px-4 py-2 text-sm break-all">
              ${isExpandable ? `<span class="text-lf-text-muted">${Array.isArray(value) ? `${value.length} items` : `${Object.keys(value).length} keys`}</span>` : renderValue(value)}
            </td>
          </tr>
        `);

        if (isExpandable) {
          const childEntries = Array.isArray(value) ? value.map((v, i) => [i, v]) : Object.entries(value);
          for (const [childKey, childValue] of childEntries) {
            const childFullKey = `${fullKey}.${childKey}`;
            const childIsExpandable = childValue !== null && typeof childValue === 'object';
            const childDisplayKey = Array.isArray(value) ? `${childKey}` : childKey;

            rows.push(`
              <tr class="border-b border-lf-border hover:bg-lf-bg-tertiary" data-key="${childFullKey}" data-parent="${fullKey}">
                <td class="px-4 py-2 text-sm text-lf-text-muted whitespace-nowrap align-top" style="padding-left: ${(depth + 1) * 16 + 16}px">
                  ${childIsExpandable ? `<button class="json-toggle mr-1 text-xs">▼</button>` : '<span class="mr-1 text-xs opacity-0">▶</span>'}
                  <span class="${Array.isArray(value) ? 'text-lf-purple' : ''}">${escapeHtml(String(childDisplayKey))}</span>
                </td>
                <td class="px-4 py-2 text-sm break-all">
                  ${childIsExpandable ? `<span class="text-lf-text-muted">${Array.isArray(childValue) ? `${childValue.length} items` : `${Object.keys(childValue).length} keys`}</span>` : renderValue(childValue)}
                </td>
              </tr>
            `);

            if (childIsExpandable) {
              rows.push(...renderNestedRows(childValue, childFullKey, depth + 2));
            }
          }
        }
      }

      return `
        <table class="w-full">
          <thead class="bg-lf-bg-tertiary">
            <tr class="text-xs text-lf-text-muted uppercase">
              <th class="px-4 py-2 text-left font-medium w-1/3">Path</th>
              <th class="px-4 py-2 text-left font-medium">Value</th>
            </tr>
          </thead>
          <tbody>${rows.join('')}</tbody>
        </table>
      `;
    }

    function renderNestedRows(obj, prefix, depth) {
      const rows = [];
      const entries = Array.isArray(obj) ? obj.map((v, i) => [i, v]) : Object.entries(obj);

      for (const [key, value] of entries) {
        const fullKey = `${prefix}.${key}`;
        const isExpandable = value !== null && typeof value === 'object';
        const displayKey = Array.isArray(obj) ? `${key}` : key;

        rows.push(`
          <tr class="border-b border-lf-border hover:bg-lf-bg-tertiary" data-key="${fullKey}" data-parent="${prefix}">
            <td class="px-4 py-2 text-sm text-lf-text-muted whitespace-nowrap align-top" style="padding-left: ${depth * 16 + 16}px">
              ${isExpandable ? `<button class="json-toggle mr-1 text-xs">▼</button>` : '<span class="mr-1 text-xs opacity-0">▶</span>'}
              <span class="${Array.isArray(obj) ? 'text-lf-purple' : ''}">${escapeHtml(String(displayKey))}</span>
            </td>
            <td class="px-4 py-2 text-sm break-all">
              ${isExpandable ? `<span class="text-lf-text-muted">${Array.isArray(value) ? `${value.length} items` : `${Object.keys(value).length} keys`}</span>` : renderValue(value)}
            </td>
          </tr>
        `);

        if (isExpandable) {
          rows.push(...renderNestedRows(value, fullKey, depth + 1));
        }
      }

      return rows;
    }

    function renderValue(value) {
      if (value === null) return '<span class="json-null">null</span>';
      if (value === undefined) return '<span class="json-null">undefined</span>';
      if (typeof value === 'boolean') return `<span class="json-boolean">${value}</span>`;
      if (typeof value === 'number') return `<span class="json-number">${value}</span>`;
      if (typeof value === 'string') {
        const escaped = escapeHtml(value);
        if (value.length > 200) return `<span class="json-string">"${escaped.slice(0, 200)}..."</span>`;
        return `<span class="json-string">"${escaped}"</span>`;
      }
      return escapeHtml(String(value));
    }

    // ==================== NAVIGATION ====================
    function showPage(page) {
      traceListPage.classList.toggle('hidden', page !== 'list');
      traceDetailPage.classList.toggle('hidden', page !== 'detail');
    }

    backBtn.addEventListener('click', () => {
      currentTrace = null;
      selectedNode = null;
      showPage('list');
    });

    // ==================== HELPERS ====================
    function formatDate(dateVal) {
      if (!dateVal) return '-';
      try {
        const d = typeof dateVal === 'number' ? new Date(dateVal * 1000) : new Date(dateVal);
        if (isNaN(d.getTime())) return '-';
        return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
      } catch { return '-'; }
    }

    function formatDateTime(dateVal) {
      if (!dateVal) return '-';
      try {
        const d = new Date(dateVal);
        if (isNaN(d.getTime())) return '-';
        return d.toLocaleString();
      } catch { return '-'; }
    }

    function formatDuration(ms) {
      if (!ms && ms !== 0) return '-';
      if (ms < 1000) return `${Math.round(ms)}ms`;
      return `${(ms / 1000).toFixed(2)}s`;
    }

    function formatNumber(n) {
      if (!n && n !== 0) return '-';
      if (n >= 1000000) return `${(n / 1000000).toFixed(1)}M`;
      if (n >= 1000) return `${(n / 1000).toFixed(1)}K`;
      return n.toString();
    }

    function formatCost(cost) {
      if (!cost) return '-';
      if (cost < 0.001) return `$${cost.toFixed(6)}`;
      if (cost < 0.01) return `$${cost.toFixed(4)}`;
      return `$${cost.toFixed(2)}`;
    }

    function getDurationBadge(ms) {
      if (!ms) return 'badge-blue';
      if (ms >= 5000) return 'badge-yellow';
      if (ms >= 10000) return 'badge-yellow';
      return 'badge-blue';
    }

    function getDurationColor(ms) {
      if (!ms) return 'text-lf-text-muted';
      if (ms >= 5000) return 'text-lf-yellow';
      if (ms >= 2000) return 'text-lf-orange';
      return 'text-lf-text';
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
  </script>
</body>
</html>
